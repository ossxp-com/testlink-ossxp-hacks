From: Jiang Xin <worldhello.net@gmail.com>
Subject: [PATCH] t/demo_login

See #81: 在登录页面提供演示帐号。如果用户尚未注册帐号，可以先使用演示帐号登录系统。

Signed-off-by: Jiang Xin <worldhello.net@gmail.com>

---
 gui/templates/login.tpl             |   16 +++++++++-
 gui/themes/default/css/testlink.css |   24 +++++++++++++++
 login.php                           |   54 +++++++++++++++++++++++++++++++++-
 3 files changed, 91 insertions(+), 3 deletions(-)

diff --git a/gui/templates/login.tpl b/gui/templates/login.tpl
index 77bdd48..035a91f 100644
--- a/gui/templates/login.tpl
+++ b/gui/templates/login.tpl
@@ -28,6 +28,7 @@ window.onload=function()
 
 <div class="forms" id="login_div">
 
+{if !$link_login}
 	<form method="post" name="login_form" action="login.php">
     {if $gui->login_disabled eq 0}		
   	  <div class="messages" style="text-align:center;">{$gui->note}</div>
@@ -41,7 +42,20 @@ window.onload=function()
 		<input type="submit" name="login_submit" value="{$labels.btn_login}" />
 		{/if}
 	</form>
+{else}
+  <div>
+  	<div class="messages" style="text-align:center;">{$gui->note}</div>
+	  {$link_login}
+	</div>
+{/if}
 	
+{if $link_demo_users}
+	<div>
+  	<div class="messages" style="text-align:center;">{$demo_login_title}</div>
+		{$link_demo_users}
+	</div>
+{/if}
+
 	<p>
 	{if $gui->user_self_signup}
 		<a href="firstLogin.php">{$labels.new_user_q}</a><br />
@@ -66,4 +80,4 @@ window.onload=function()
 
 </div>
 </body>
-</html>
\ No newline at end of file
+</html>
diff --git a/gui/themes/default/css/testlink.css b/gui/themes/default/css/testlink.css
index a945f26..8463cb1 100644
--- a/gui/themes/default/css/testlink.css
+++ b/gui/themes/default/css/testlink.css
@@ -761,4 +761,28 @@ th.testlink, td.testlink, tr.testlink td {
 .x-tl-panel-body{overflow:hidden;}
 .x-tl-panel-collapsed .x-resizable-handle{display:none;}
 
+
+a.urlbtn,a.urlbtn:link,a.urlbtn:visited
+{
+  display:block;
+  color:#FFFFFF;
+  background-color:#98bf21;
+  font-weight:bold;
+  font-size:11px;
+  text-align:center;
+  width: 80%;
+  padding:0;
+  padding-top:3px;
+  padding-bottom:4px;
+  border:1px solid #ffffff;
+  outline:1px solid #98bf21;
+  text-decoration:none;
+  margin-left:1px;
+}
+
+a.urlbtn:hover,a.urlbtn:active
+{
+  background-color:#7A991A;
+}
+
 /* ----- END ------------------------------------------------------------------------- */
diff --git a/login.php b/login.php
index 9606dc6..6982c13 100644
--- a/login.php
+++ b/login.php
@@ -47,12 +47,25 @@ if (strtolower($tlCfg->authentication['method']) == 'cosign')
 	}
 }
 
-if(!is_null($args->login) || $cosign_loggedin)
+if(!is_null($args->login) || $cosign_loggedin || $args->demo)
 {
 	doSessionStart();
 	unset($_SESSION['basehref']);
 	setPaths();
 
+	if($args->demo)
+	{
+		if (array_key_exists($args->demo, $tlCfg->authentication['demo_users']))
+		{
+			$args->login = $args->demo;
+			$cosign_loggedin = 1;
+		}
+		else
+		{
+			$args->demo = "";
+			$gui->note = lang_get('bad_user_passwd');
+		}
+	}
 	if(doAuthorize($db,$args->login,$args->pwd,$msg,$cosign_loggedin) < tl::OK)
 	{
 		if (!$msg)
@@ -73,17 +86,51 @@ if(!is_null($args->login) || $cosign_loggedin)
 	}
 }
 
-if (strtolower($tlCfg->authentication['method']) == 'cosign')
+if (strtolower($tlCfg->authentication['method']) == 'cosign' &&
+		($args->sso || !@$tlCfg->authentication['demo_users']))
 {
 	// Redirect to cosign login page.
 	sso_redirect();
 }
 
+$link_demo_users = "";
+$link_login = "";
+if (@$tlCfg->authentication['demo_users'])
+{
+	if (strtolower($tlCfg->authentication['method']) == 'cosign')
+	{
+		$link_login = "<p><div align=\"center\" ".
+                  "<a href=\"" .
+		              $_SERVER["PHP_SELF"] .
+		              "?sso\" class=\"urlbtn\">" .
+		              lang_get('sso_login_url_text') .
+	                "</a></div><p>";
+	}
+
+  $link_demo_users =  "<p>" .
+                      lang_get('demo_login_text') .
+                      "<p>";
+	foreach ($tlCfg->authentication['demo_users'] as $role => $text)
+	{
+		$link_demo_users .= "<a href=\"" .
+		                    $_SERVER["PHP_SELF"] .
+	                      "?demo=$role\" class=\"rlbtn\">" .
+		                    "&#187;". $text .
+	                      "</a>, ";
+	}
+	$link_demo_users = "<div align=\"center\" width=\"80%\">" .
+                     rtrim($link_demo_users," ,") . "<div>" ;
+}
+
+
 $logPeriodToDelete = config_get('removeEventsOlderThan');
 $g_tlLogger->deleteEventsFor(null, strtotime("-{$logPeriodToDelete} days UTC"));
 
 $smarty = new TLSmarty();
 $smarty->assign('gui', $gui);
+$smarty->assign('demo_login_title', lang_get('demo_login_title'));
+$smarty->assign('link_demo_users', $link_demo_users);
+$smarty->assign('link_login', $link_login);
 $smarty->display('login.tpl');
 
 /**
@@ -130,6 +177,9 @@ function init_args()
     $args->reqURI = isset($_REQUEST['req']) ? urlencode($_REQUEST['req']) : null;
     $args->preqURI = (isset($_REQUEST['reqURI']) && strlen($_REQUEST['reqURI'])) ? urlencode($_REQUEST['reqURI']) : null;
   
+    $args->sso = isset($_REQUEST['sso']) ? 1 : 0;
+    $args->demo = isset($_REQUEST['demo']) ? $_REQUEST['demo'] : '';
+
     return $args;
 }
 
-- 
tg: (dc6818c..) t/demo_login (depends on: t/single_signon)
